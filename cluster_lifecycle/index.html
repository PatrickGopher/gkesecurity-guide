



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-\.]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Cluster Lifecycle - The Unofficial GKE Security Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#cluster-lifecycle" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="The Unofficial GKE Security Guide" class="md-header-nav__button md-logo">
          
            <i class="md-icon">cloud</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              The Unofficial GKE Security Guide
            </span>
            <span class="md-header-nav__topic">
              
                Cluster Lifecycle
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/bgeesaman/gkesecurity-guide/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    bgeesaman/gkesecurity-guide
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="The Unofficial GKE Security Guide" class="md-nav__button md-logo">
      
        <i class="md-icon">cloud</i>
      
    </a>
    The Unofficial GKE Security Guide
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/bgeesaman/gkesecurity-guide/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    bgeesaman/gkesecurity-guide
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cloud_environment/" title="Cloud Environment" class="md-nav__link">
      Cloud Environment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../project_organization/" title="Project Organization" class="md-nav__link">
      Project Organization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cluster_configuration/" title="Cluster Configuration" class="md-nav__link">
      Cluster Configuration
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Cluster Lifecycle
      </label>
    
    <a href="./" title="Cluster Lifecycle" class="md-nav__link md-nav__link--active">
      Cluster Lifecycle
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#infrastructure-as-code" title="Infrastructure as Code" class="md-nav__link">
    Infrastructure as Code
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resources" title="Resources" class="md-nav__link">
    Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrades-and-security-fixes" title="Upgrades and Security Fixes" class="md-nav__link">
    Upgrades and Security Fixes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#control-plane-upgrades" title="Control Plane Upgrades" class="md-nav__link">
    Control Plane Upgrades
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-pool-upgrades" title="Node Pool Upgrades" class="md-nav__link">
    Node Pool Upgrades
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-bulletins" title="Security Bulletins" class="md-nav__link">
    Security Bulletins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resources_1" title="Resources" class="md-nav__link">
    Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling" title="Scaling" class="md-nav__link">
    Scaling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resources_2" title="Resources" class="md-nav__link">
    Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cluster_observability/" title="Cluster Observability" class="md-nav__link">
      Cluster Observability
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cluster_addons/" title="Cluster Add-ons" class="md-nav__link">
      Cluster Add-ons
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../workload_configuration/" title="Workload Configuration" class="md-nav__link">
      Workload Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../container_images/" title="Container Images" class="md-nav__link">
      Container Images
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../audit_and_compliance/" title="Audit and Compliance" class="md-nav__link">
      Audit and Compliance
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../detection_and_response/" title="Detection and Response" class="md-nav__link">
      Detection and Response
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#infrastructure-as-code" title="Infrastructure as Code" class="md-nav__link">
    Infrastructure as Code
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resources" title="Resources" class="md-nav__link">
    Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrades-and-security-fixes" title="Upgrades and Security Fixes" class="md-nav__link">
    Upgrades and Security Fixes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#control-plane-upgrades" title="Control Plane Upgrades" class="md-nav__link">
    Control Plane Upgrades
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-pool-upgrades" title="Node Pool Upgrades" class="md-nav__link">
    Node Pool Upgrades
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-bulletins" title="Security Bulletins" class="md-nav__link">
    Security Bulletins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resources_1" title="Resources" class="md-nav__link">
    Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling" title="Scaling" class="md-nav__link">
    Scaling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resources_2" title="Resources" class="md-nav__link">
    Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/bgeesaman/gkesecurity-guide/edit/master/docs/cluster_lifecycle.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="cluster-lifecycle">Cluster Lifecycle<a class="headerlink" href="#cluster-lifecycle" title="Permanent link">&para;</a></h1>
<h2 id="infrastructure-as-code">Infrastructure as Code<a class="headerlink" href="#infrastructure-as-code" title="Permanent link">&para;</a></h2>
<p>Creating GKE <code>clusters</code> using <code>gcloud</code> or the UI console is sufficient for testing purposes, but production-ready deployments should be managed with purpose-built tooling that declaratively set the defined state of infrastructure in code form.  Terraform handles this well and it provides an easy to read example code base for how the security-related features are configured:</p>
<div class="codehilite"><pre><span></span><span class="go">provider &quot;google-beta&quot; {</span>
<span class="go">  version = &quot;2.13.0&quot;</span>
<span class="go">  project = &quot;my-project-id&quot;</span>
<span class="go">  region  = &quot;us-central1&quot;</span>
<span class="go">}</span>


<span class="go">resource &quot;google_container_cluster&quot; &quot;my-cluster-name&quot; {</span>
<span class="go">  provider = &quot;google-beta&quot;</span>

<span class="go">  name     = &quot;my-cluster-name&quot;</span>
<span class="go">  project  = &quot;my-project-id&quot;</span>

<span class="go">  // Configures a highly-available control plane spread across three</span>
<span class="go">  // zones in this region</span>
<span class="go">  location = &quot;us-central1&quot;</span>

<span class="go">  // It&#39;s best to create these networks and subnets in terraform</span>
<span class="go">  // and then reference them here.</span>
<span class="go">  network    = google_compute_network.network.self_link</span>
<span class="go">  subnetwork = google_compute_subnetwork.subnetwork.self_link</span>

<span class="go">  // Set this to the version desired.  It will become the starting</span>
<span class="go">  // point version for the cluster.  Upgrades of the control plane</span>
<span class="go">  // can be initiated by simply bumping this version and running</span>
<span class="go">  // terraform apply.</span>
<span class="go">  min_master_version = &quot;1.13.7-gke19&quot;</span>

<span class="go">  // Specify the newer Kubernetes logging and monitoring features</span>
<span class="go">  // of the Stackdriver integration.</span>
<span class="go">  // Previously &quot;logging.googleapis.com&quot;</span>
<span class="go">  logging_service    = &quot;logging.googleapis.com/kubernetes&quot;</span>
<span class="go">  monitoring_service = &quot;monitoring.googleapis.com/kubernetes&quot;</span>

<span class="go">  // Do not use the default node pool that GKE provides and instead</span>
<span class="go">  // use the node pool(s) define below explicitly.  GKE will actually</span>
<span class="go">  // provision a 1 node node pool and then remove it before making the</span>
<span class="go">  // node pools below.</span>
<span class="go">  remove_default_node_pool = true</span>
<span class="go">  initial_node_count       = 1</span>

<span class="go">  // This is false by default.  RBAC is enabled by default and preferred. </span>
<span class="go">  enable_legacy_abac = false</span>

<span class="go">  // Enable the Binary Authorization admission controller to allow</span>
<span class="go">  // this cluster to evaluate a BinAuthZ policy when pods are created</span>
<span class="go">  // to ensure images come from the proper sources.</span>
<span class="go">  enable_binary_authorization = true</span>

<span class="go">  // Defines the kubelet setting for how many pods could potentially</span>
<span class="go">  // run on this node.  Depending on instance type, setting this to</span>
<span class="go">  // 64 would be more appropriate and use half the IP space.</span>
<span class="go">  default_max_pods_per_node = 110</span>

<span class="go">  // Enable transparent &quot;application level&quot; encryption of etcd secrets</span>
<span class="go">  // using a KMS keyring/key.  Can be a software or HSM-backed KMS key</span>
<span class="go">  // for extra compliance requirements.</span>
<span class="go">  database_encryption {</span>
<span class="go">    key_name = &quot;my-existing-kms-key&quot;</span>
<span class="go">    state    = &quot;ENCRYPTED&quot;</span>
<span class="go">  }</span>

<span class="go">  addons_config {</span>
<span class="go">    // Do not deploy the in-cluster K8s dashboard and defer to kubectl</span>
<span class="go">    // and the GCP UI console.</span>
<span class="go">    kubernetes_dashboard {</span>
<span class="go">      disabled = true</span>
<span class="go">    }</span>

<span class="go">    // Enable network policy (Calico) as an addon.</span>
<span class="go">    network_policy_config {</span>
<span class="go">      disabled = false</span>
<span class="go">    }</span>

<span class="go">    // Provide the ability to scale pod replicas based on real-time metrics</span>
<span class="go">    horizontal_pod_autoscaling {</span>
<span class="go">      disabled = false</span>
<span class="go">    }</span>
<span class="go">  }</span>

<span class="go">  // Enable intranode visibility to expose pod-to-pod traffic to the VPC</span>
<span class="go">  // for flow logging potential.  Requires enabling VPC Flow Logging</span>
<span class="go">  // on the subnet first</span>
<span class="go">  enable_intranode_visibility = true</span>

<span class="go">  // Enables the PSP admission controller in the cluster.  DO NOT enable this</span>
<span class="go">  // on an existing cluster without first configuring the necessary pod security</span>
<span class="go">  // policies and RBAC role bindings or you will inhibit pods from running</span>
<span class="go">  // until those are correctly configured.  Recommend success in a test env first.</span>
<span class="go">  pod_security_policy_config {</span>
<span class="go">    enabled = true</span>
<span class="go">  }</span>

<span class="go">  // Enable the VPA addon in the cluster to track actual usage vs requests/limits.</span>
<span class="go">  // Safe to enable at any time.</span>
<span class="go">  vertical_pod_autoscaling {</span>
<span class="go">    enabled = true</span>
<span class="go">  }</span>

<span class="go">  // Configure the workload identity &quot;identity namespace&quot;.  Requires additional</span>
<span class="go">  // configuration on the node pool for workload identity to function.</span>
<span class="go">  workload_identity_config {</span>
<span class="go">    identity_namespace = &quot;my-project-id.svc.goog.id&quot;</span>
<span class="go">  }</span>

<span class="go">  // Disable basic authentication and cert-based authentication.</span>
<span class="go">  // Empty fields for username and password are how to &quot;disable&quot; the</span>
<span class="go">  // credentials from being generated.</span>
<span class="go">  master_auth {</span>
<span class="go">    username = &quot;&quot;</span>
<span class="go">    password = &quot;&quot;</span>

<span class="go">    client_certificate_config {</span>
<span class="go">      issue_client_certificate = false</span>
<span class="go">    }</span>
<span class="go">  }</span>

<span class="go">  // Enable network policy configurations via Calico.  Must be configured with</span>
<span class="go">  // the block in the addons section.</span>
<span class="go">  network_policy {</span>
<span class="go">    enabled = true</span>
<span class="go">  }</span>

<span class="go">  // Give GKE a 4 hour window each day in which to perform maintenance operations</span>
<span class="go">  // and required security patches. In UTC.</span>
<span class="go">  maintenance_policy {</span>
<span class="go">    daily_maintenance_window {</span>
<span class="go">      start_time = &quot;TODO&quot;</span>
<span class="go">    }</span>
<span class="go">  }</span>

<span class="go">  // Use VPC Aliasing to improve performance and reduce network hops between nodes and load balancers.  References the secondary ranges specified in the VPC subnet.</span>
<span class="go">  ip_allocation_policy {</span>
<span class="go">    use_ip_aliases                = true</span>
<span class="go">    cluster_secondary_range_name  = google_compute_subnetwork.subnetwork.secondary_ip_range.0.range_name</span>
<span class="go">    services_secondary_range_name = google_compute_subnetwork.subnetwork.secondary_ip_range.1.range_name</span>
<span class="go">  }</span>

<span class="go">  // Specify the list of CIDRs which can access the master&#39;s API.  This can be</span>
<span class="go">  // a list of up to 50 CIDRs.  It&#39;s basically a control plane firewall rulebase.</span>
<span class="go">  // Nodes automatically/always have access, so these are for users and automation</span>
<span class="go">  // systems.</span>
<span class="go">  master_authorized_networks_config {</span>
<span class="go">    cidr_blocks {</span>
<span class="go">      cidr_block = &quot;10.0.0.0/8&quot;</span>
<span class="go">      display_name = &quot;VPC Subnet&quot;</span>
<span class="go">    }</span>
<span class="go">    cidr_blocks {</span>
<span class="go">      cidr_block   = &quot;192.168.0.0/24&quot;</span>
<span class="go">      display_name = &quot;Admin Subnet&quot;</span>
<span class="go">    }</span>
<span class="go">  }</span>

<span class="go">  // Configure the cluster to have private nodes and private control plane access only</span>
<span class="go">  private_cluster_config {</span>
<span class="go">    // Enables the control plane to not be exposed via public IP and which subnet to</span>
<span class="go">    // use an IP from.</span>
<span class="go">    enable_private_endpoint = true</span>
<span class="go">    master_ipv4_cidr_block  = &quot;172.20.20.0/28&quot;</span>
<span class="go">    // Specifies that all nodes in all node pools for this cluster should not have a</span>
<span class="go">    // public IP automatically assigned.</span>
<span class="go">    enable_private_nodes    = true</span>
<span class="go">  }</span>
<span class="go">}</span>

<span class="go">resource &quot;google_container_node_pool&quot; &quot;my-node-pool&quot; {</span>
<span class="go">  provider  = &quot;google-beta&quot;</span>

<span class="go">  name       = &quot;my-node-pool&quot;</span>
<span class="go">  // Spread nodes in this node pool evenly across the three zones in this region.</span>
<span class="go">  location   = &quot;us-central1&quot;</span>
<span class="go">  cluster    = google_container_cluster.my-cluster-name.name</span>
<span class="go">  // Must be at or below the control plane version.  Bump this field to trigger a</span>
<span class="go">  // rolling node pool upgrade.</span>
<span class="go">  version    = &quot;1.13.7-gke19&quot;</span>
<span class="go">  // Because this is a regional cluster and a regional node pool, this is the</span>
<span class="go">  // number of nodes per-zone to create.  1 will create 3 total nodes.</span>
<span class="go">  node_count = 1</span>

<span class="go">  // Overrides the cluster setting on a per-node-pool basis.</span>
<span class="go">  max_pods_per_node = 110</span>

<span class="go">  // The min and max number of nodes (per-zone) to scale to.  This defines a three</span>
<span class="go">  // to 30 node cluster.</span>
<span class="go">  autoscaling {</span>
<span class="go">    min_node_count = 1</span>
<span class="go">    max_node_count = 10</span>
<span class="go">  }</span>

<span class="go">  // Fix broken nodes automatically and keep them updated with the control plane.</span>
<span class="go">  management {</span>
<span class="go">    auto_repair  = &quot;true&quot;</span>
<span class="go">    auto_upgrade = &quot;true&quot;</span>
<span class="go">  }</span>

<span class="go">  node_config {</span>
<span class="go">    machine_type    = &quot;n1-standard-1&quot;</span>
<span class="go">    // pd-standard is often too slow, so using pd-ssd&#39;s is recommended for pods</span>
<span class="go">    // that do any scratch disk operations.</span>
<span class="go">    disk_type       = &quot;pd-ssd&quot; </span>
<span class="go">    // COS or COS_containerd are ideal here.  Ubuntu if specific kernel features or</span>
<span class="go">    // disk drivers are necessary.</span>
<span class="go">    image_type      = &quot;COS&quot;</span>

<span class="go">    // Use a custom service account for this node pool.  Be sure to grant it</span>
<span class="go">    // a minimal amount of IAM roles and not Project Editor like the default SA.</span>
<span class="go">    service_account = &quot;dedicated-sa-name@my-project-id.iam.gserviceaccount.com&quot;</span>

<span class="go">    // Use the default/minimal oauth scopes to help restrict the permissions to</span>
<span class="go">    // only those needed for GCR and stackdriver logging/monitoring/tracing needs.</span>
<span class="go">    oauth_scopes = [</span>
<span class="go">      &quot;https://www.googleapis.com/auth/devstorage.read_only&quot;,</span>
<span class="go">      &quot;https://www.googleapis.com/auth/logging.write&quot;,</span>
<span class="go">      &quot;https://www.googleapis.com/auth/monitoring&quot;,</span>
<span class="go">      &quot;https://www.googleapis.com/auth/servicecontrol&quot;,</span>
<span class="go">      &quot;https://www.googleapis.com/auth/service.management.readonly&quot;,</span>
<span class="go">      &quot;https://www.googleapis.com/auth/trace.append&quot;</span>
<span class="go">    ]</span>

<span class="go">    // Enable GKE Sandbox (Gvisor) on this node pool.  This cannot be set on the</span>
<span class="go">    // only node pool in the cluster as system workloads are not all compatible</span>
<span class="go">    // with the restrictions and protections offered by gvisor.</span>
<span class="go">    sandbox_config {</span>
<span class="go">      sandbox_type = &quot;gvisor&quot;</span>
<span class="go">    }</span>

<span class="go">    // Protect node metadata and enable Workload Identity</span>
<span class="go">    // for this node pool.  &quot;SECURE&quot; just protects the metadata.</span>
<span class="go">    // &quot;EXPOSE&quot; or not set allows for cluster takeover.</span>
<span class="go">    // &quot;GKE_METADATA_SERVER&quot; specifies that each pod&#39;s requests to the metadata</span>
<span class="go">    // API for credentials should be intercepted and given the specific</span>
<span class="go">    // credentials for that pod only and not the node&#39;s.</span>
<span class="go">    workload_metadata_config {</span>
<span class="go">      node_metadata = &quot;GKE_METADATA_SERVER&quot;</span>
<span class="go">    }</span>

<span class="go">    metadata = {</span>
<span class="go">      // Set metadata on the VM to supply more entropy</span>
<span class="go">      google-compute-enable-virtio-rng = &quot;true&quot;</span>
<span class="go">      // Explicitly remove GCE legacy metadata API endpoint to prevent most SSRF</span>
<span class="go">      // bugs in apps running on pods inside the cluster from giving attackers</span>
<span class="go">      // a path to pull the GKE metadata/bootstrapping credentials.</span>
<span class="go">      disable-legacy-endpoints = &quot;true&quot;</span>
<span class="go">    }</span>

<span class="go">  }</span>
<span class="go">}</span>
</pre></div>

<h3 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://terraform.io">Terraform</a></li>
<li><a href="https://www.terraform.io/docs/providers/google/r/container_cluster.html">Terraform Cluster Provider</a></li>
<li><a href="https://www.terraform.io/docs/providers/google/r/container_node_pool.html">Terraform Node Pool Provider</a></li>
</ul>
<h2 id="upgrades-and-security-fixes">Upgrades and Security Fixes<a class="headerlink" href="#upgrades-and-security-fixes" title="Permanent link">&para;</a></h2>
<h3 id="control-plane-upgrades">Control Plane Upgrades<a class="headerlink" href="#control-plane-upgrades" title="Permanent link">&para;</a></h3>
<p>One of the most important problems that GKE helps solve is maintaining the control plane components for you.  Using <code>gcloud</code> or the UI console, upgrading the control plane version is a single API call.  There are a few important concepts to understand with this feature:</p>
<ul>
<li><strong>The version of the control plane can and should be kept updated.</strong> - GKE supports the current "Generally Available" (GA) GKE version back to two older minor revisions.  For instance, if the GA version is <code>1.13.7-gke19</code>, then <code>1.11.x</code> and <code>1.12.x</code> are supported.</li>
<li><strong>GKE versions tend to trail Kubernetes OSS slightly.</strong> - Kubernetes OSS releases a minor revision approximately every 90-120 days, and GKE is quick to offer "Alpha" releases with those newest versions, but it may take some time to graduate to "GA" in GKE.</li>
<li>
<p><strong>Control Plane upgrades of Zonal clusters incurs a few minutes of downtime.</strong> - Upgrading to a newer GKE version causes each control plane instance to be recreated in-place. On <code>zonal</code> clusters, there is a few minutes where that single instance is unavailable while it is being recreated.  The data in <code>etcd</code> is kept as-is and all workloads that are running on the <code>node pools</code> remain in place.  However, access to the API with <code>kubectl</code> will be temporarily halted.</p>
<p>Regional clusters perform a "rolling upgrade" approach to upgrading the three control plane instances, and so the upgrade happens one instance at a time.  This leaves the control plane available on the other instances and should incur no noticable downtime.</p>
<p>For the sake of a highly-available control plane and the bonus that is no additional cost, it's recommended to run <code>regional</code> clusters.  If inter-regional traffic costs are a concern, use the <code>node locations</code> setting to use a single <code>zone</code> but still keep the <code>regional</code> control plane.</p>
</li>
</ul>
<h3 id="node-pool-upgrades">Node Pool Upgrades<a class="headerlink" href="#node-pool-upgrades" title="Permanent link">&para;</a></h3>
<p>Upgrades of <code>node pools</code> are handled per-<code>node pool</code>, and this gives the operator a lot of control over the behavior.  If <code>auto-upgrades</code> are enabled, the <code>node pools</code> will be scheduled for "rolling upgrade" style upgrades during the configured <code>maintenance window</code> time block.  While it's possible to have <code>node pools</code> trail the control plane version by two minor revisions, it's best to not trail more than one.</p>
<p>As <code>node pools</code> are where workloads are running, a few points are important to understand:</p>
<ul>
<li><strong>Node Pools are resource boundaries</strong> - If certain workloads are resource-intensive or prone to over-consuming resources in large bursts, it may make sense to dedicate a <code>node pool</code> to them to reduce the potential for negatively affecting the performance and availability of other workloads.</li>
<li><strong>Each Node Pool adds operational maintenance overhead</strong> - Quite simply, each <code>node pool</code> adds more work to the operations team.  Either to ensure is automatically upgraded or to perform the upgrades manually if auto-upgrades are disabled.</li>
<li>
<p><strong>Separating workloads to different Node Pools can help support security goals</strong> - While not a perfect solution, ensuring that workloads handling certain sensitive data are scheduled on separate <code>node pools</code> (using <code>node taints</code> and <code>tolerations</code> on workloads) can help reduce the chance of compromising <code>secrets</code> in a container "escape-to-the-host" situation.</p>
<p>For example, placing PCI-related workloads on a separate <code>node pool</code> from other non-PCI workloads means that a compromise of a non-PCI <code>pod</code> that allows access to the underlying <code>host</code> will be less likely to have access to <code>secrets</code> that the PCI workloads are using.</p>
</li>
</ul>
<h3 id="security-bulletins">Security Bulletins<a class="headerlink" href="#security-bulletins" title="Permanent link">&para;</a></h3>
<p>Another benefit of a managed service like GKE is the reduced operational security burden on having to triage, test, and manage upgrades due to security issues.  The GKE Security Bulletins website and Atom/RSS feed provide a consolidated view of all things security-related in GKE.  It is strongly recommended that teams subscribe to and receive automatic updates from the feed as the information is timely and typically very clear on which actions GKE the service is taking and which actions are left to you.</p>
<h3 id="resources_1">Resources<a class="headerlink" href="#resources_1" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster#upgrading_the_master">GKE Cluster Upgrades</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster#upgrading_nodes">GKE Node Pool Upgrades</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-upgrades">Automatic Node Upgrades</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/security-bulletins">GKE Security Bulletins</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/release-notes">GKE Release Notes</a></li>
</ul>
<h2 id="scaling">Scaling<a class="headerlink" href="#scaling" title="Permanent link">&para;</a></h2>
<p>While scaling isn't a purely security-related topic, there are a few security and resource availability concerns with each of the common scaling patterns:</p>
<ul>
<li>
<p><strong>Node Sizing</strong> - The resources available to GKE worker <code>nodes</code> are shared by all <code>pods</code> that are scheduled on them.  While there are solid <code>limits</code> on CPU and RAM usage, there are not strong resource isolation mechanisms (yet) for disk usage that lands on the <code>node</code>.  It is possible for a single <code>pod</code> to consume enough disk space and/or inodes and disrupt the health of the <code>node</code>.</p>
<p>Depending on the workload profile you plan on running in the <code>cluster</code>, it might make sense to have more <code>nodes</code> of a smaller instance type with the faster <code>pd-ssd</code> <code>disk type</code> than fewer large instances sharing the slower <code>pd-hdd</code> <code>disk type</code>, for example.  When workload resource profiles drastically differ, it might make sense to use separate <code>node pools</code> or even separate <code>clusters</code>.</p>
</li>
<li>
<p><strong>Horizontal Pod Autoscaler</strong> - The built-in capability of scaling <code>replicas</code> in a <code>deployment</code> based on CPU usage may or may not be granular enough for your needs.  Ensure that the total capacity of the <code>cluster</code> (capacity of the max number of <code>nodes</code> allowed by autoscaling) is greater than the resources used by the max number of <code>replicas</code> in the <code>deployment</code>.  Also, consider using "external" metrics from Stackdriver like "number of tasks in a pub/sub queue" or "web requests per pod" to be a more accurate and efficient basis for scaling your workloads.</p>
</li>
<li>
<p><strong>Vertical Pod Autoscaler</strong> - Horizontal Pod Autoscaling adds more <code>replicas</code> as needed, but that is assuming the <code>pod</code> has properly set resource <code>requests</code> and <code>limits</code> for CPU and RAM set.  Each <code>pod</code> should be configured with the proper <code>requests</code> for how much CPU and RAM it uses plus 5-10% at idle for its <code>requests</code> setting.  The <code>limit</code> should be the maximum CPU and RAM that the <code>pod</code> will ever use.</p>
<p>Having accurate <code>requests</code> and <code>limits</code> set for every <code>pod</code> gives the scheduler the correct information for how to place workloads, increases efficiency of resource usage, and reduces the risk of "noisy neighbor" issues from <code>pods</code> that consume more than their set share of resources.</p>
<p>VPA runs inside the <code>cluster</code> and can monitor workloads for configured <code>requests</code> and <code>limits</code> in comparison with actual usage, and can either "audit" (just make recommendations) or actually modify the <code>deployments</code> dynamically.  It's recommended to run VPA in a <code>cluster</code> in "audit" mode to help find misconfigured <code>pods</code> before they cause <code>cluster</code>-wide outages.</p>
</li>
<li>
<p><strong>Node Autoprovisioner</strong> - The GKE cluster-autoscaler adds or removes <code>nodes</code> from existing <code>node pools</code> based on their available capacity.  If a <code>deployment</code> needs more <code>replicas</code>, there are not enough running <code>nodes</code> to handle them, the <code>node pool</code> is configured to autoscale, and there are more <code>nodes</code> left before the maximum is reached, the autoscaler will add <code>nodes</code> until the workloads are scheduled.</p>
<p>But what if a <code>pod</code> is asking for resources that a new <code>node</code> can't handle?  For example, a <code>pod</code> that asks for <code>16</code> cpu cores but the <code>nodes</code> are only <code>8</code> core instances?  Or if a <code>pod</code> needs a GPU but the <code>node pool</code> doesn't attach GPUs?  The node autoprovisioner can be configured to <em>dynamically manage node pools</em> for you to help satisfy these situations.  Instead of waiting for an administrator to add a new <code>node pool</code>, the cluster autoscaler can do that for you.</p>
</li>
</ul>
<h3 id="resources_2">Resources<a class="headerlink" href="#resources_2" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://cloud.google.com/solutions/scope-and-size-kubernetes-engine-clusters">GKE Cluster Sizing</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/resizing-a-cluster">GKE Cluster Resizing</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/scaling-apps">Horizontal Pod Autoscaler</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/verticalpodautoscaler">Vertical Pod Autoscaler</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-provisioning">GKE Node Auto-Provisioner</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../cluster_configuration/" title="Cluster Configuration" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Cluster Configuration
              </span>
            </div>
          </a>
        
        
          <a href="../cluster_observability/" title="Cluster Observability" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Cluster Observability
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/bgeesaman" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/bradgeesaman" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/bradgeesaman" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>